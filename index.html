<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scoreboard Overlay</title>
<style>
  :root{
    --font-family: "Noto Sans KR", "Arial", sans-serif;
    --team-font-size: 36px;
    --score-font-size: 96px;
    --sets-font-size: 20px;
    --meta-font-size: 18px;
    --border-color: #ffffff;
    --border-width: 6px;
    --cell-bg: rgba(0,0,0,0.45);
    --accent: #ffcc00;
    --text-color: #ffffff;
    --corner-radius: 12px;
  }
  html,body{height:100%;margin:0;background:transparent;font-family:var(--font-family);color:var(--text-color);}
  .wrap{display:flex;align-items:center;justify-content:center;height:100%;padding:20px;box-sizing:border-box;}
  .board{
    display:flex;align-items:center;gap:24px;
    background:var(--cell-bg);
    border:var(--border-width) solid var(--border-color);
    border-radius:var(--corner-radius);
    padding:18px 28px;
    min-width:720px;
  }
  .team{
    display:flex;flex-direction:column;align-items:center;min-width:220px;
  }
  .team .name{font-size:var(--team-font-size);font-weight:700;letter-spacing:0.5px;}
  .team .score-row{display:flex;align-items:center;gap:12px;margin-top:8px;}
  .team .score{font-size:var(--score-font-size);font-weight:900;}
  .team .sets{font-size:var(--sets-font-size);background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;border:2px solid rgba(255,255,255,0.06);}
  .meta{display:flex;flex-direction:column;align-items:center;gap:6px;padding:6px 12px;}
  .tournament{font-size:var(--meta-font-size);opacity:0.95;font-weight:700;}
  .set-info{font-size:var(--meta-font-size);opacity:0.9;}
  .limit{font-size:14px;opacity:0.8;}
  @media (max-width:900px){
    :root{--score-font-size:64px;--team-font-size:28px;}
    .board{padding:12px;}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="board" id="board" role="region" aria-live="polite">
    <div class="team" id="team1">
      <div class="name" id="team1_name">TEAM 1</div>
      <div class="score-row">
        <div class="score" id="team1_score">0</div>
        <div class="sets" id="team1_sets" title="Sets won">0</div>
      </div>
    </div>

    <div class="meta">
      <div class="tournament" id="tournament">TOURNAMENT</div>
      <div class="set-info" id="set_info">SINGLE SET</div>
      <div class="limit" id="limit_info">Limit 15</div>
    </div>

    <div class="team" id="team2">
      <div class="name" id="team2_name">TEAM 2</div>
      <div class="score-row">
        <div class="score" id="team2_score">0</div>
        <div class="sets" id="team2_sets" title="Sets won">0</div>
      </div>
    </div>
  </div>
</div>

<script>
/* CONFIGURED API URL */
const API_URL = "https://script.google.com/macros/s/AKfycbxBzzmxN7MAFuwQjLrNt4iSjj91hQZxoRjZ_FH1phuEa0KAxKe0Mum27JwAukmRH1GNeg/exec";
const POLL_INTERVAL = 1000; // ms

async function fetchState(){
  try{
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('Network response not ok');
    const data = await res.json();
    applyState(data);
  }catch(err){
    console.error('fetchState error', err);
  }
}

function applyState(data){
  const cfg = data.config || {};
  const teams = data.teams || [];
  if(cfg.design){
    try{
      const d = (typeof cfg.design === 'string') ? JSON.parse(cfg.design) : cfg.design;
      for(const k in d) document.documentElement.style.setProperty(`--${k}`, d[k]);
    }catch(e){ console.warn('design parse', e); }
  }
  document.getElementById('tournament').textContent = cfg.tournament || '';
  const mode = cfg.mode || 'single';
  if(mode === 'best_of_3'){
    const current = cfg.current_set || 1;
    document.getElementById('set_info').textContent = `SET ${current} / 3`;
  } else {
    document.getElementById('set_info').textContent = 'SINGLE SET';
  }
  document.getElementById('limit_info').textContent = cfg.point_limit ? `Limit ${cfg.point_limit}` : '';

  if(teams[0]){
    document.getElementById('team1_name').textContent = teams[0].team_name || 'TEAM 1';
    document.getElementById('team1_score').textContent = teams[0].score ?? '0';
    document.getElementById('team1_sets').textContent = teams[0].sets_won ?? '0';
  }
  if(teams[1]){
    document.getElementById('team2_name').textContent = teams[1].team_name || 'TEAM 2';
    document.getElementById('team2_score').textContent = teams[1].score ?? '0';
    document.getElementById('team2_sets').textContent = teams[1].sets_won ?? '0';
  }

  const showSets = (mode === 'best_of_3');
  document.getElementById('team1_sets').style.display = showSets ? 'inline-block' : 'none';
  document.getElementById('team2_sets').style.display = showSets ? 'inline-block' : 'none';
}

fetchState();
setInterval(fetchState, POLL_INTERVAL);

/* Listen for design preview messages from design.html (postMessage) */
window.addEventListener('message', (ev) => {
  try {
    const msg = ev.data || {};
    if (msg.type === 'applyDesign' && msg.design) {
      const d = msg.design;
      for (const k in d) document.documentElement.style.setProperty(`--${k}`, d[k]);
    }
  } catch (e) { console.warn(e); }
});
</script>
</body>
</html>
