<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scoreboard Admin</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f6f7fb;color:#111;}
  h1{margin:0 0 12px 0;font-size:20px;}
  .panel{background:#fff;border-radius:8px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-width:900px;}
  .row{display:flex;gap:12px;align-items:center;margin-bottom:10px;}
  label{width:120px;font-weight:700;}
  input[type="text"], input[type="number"], select{flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;}
  button{padding:10px 14px;border-radius:6px;border:0;background:#2b6ef6;color:#fff;font-weight:700;cursor:pointer;}
  button.secondary{background:#6b7280;}
  .teams{display:flex;gap:12px;margin-top:8px;}
  .team-box{flex:1;background:#fafbff;padding:12px;border-radius:8px;border:1px solid #eef2ff;}
  .small{font-size:13px;color:#666;margin-top:6px;}
</style>
</head>
<body>
<div class="panel">
  <h1>Scoreboard Admin</h1>

  <div class="row">
    <label>API URL</label>
    <input id="apiUrl" type="text" value="https://script.google.com/macros/s/AKfycbxBzzmxN7MAFuwQjLrNt4iSjj91hQZxoRjZ_FH1phuEa0KAxKe0Mum27JwAukmRH1GNeg/exec" />
  </div>

  <div class="row">
    <label>Admin Token</label>
    <input id="adminToken" type="text" value="jceGvOOeuPd0-vRclIuSQS7Pm-n7-BEfcK-sifBsNnRHX4zTzXfLdkWk2_4XF6u8" />
  </div>

  <div class="row">
    <label>Tournament</label>
    <input id="tournament" type="text" placeholder="대회명" />
  </div>

  <div class="row">
    <label>Mode</label>
    <select id="mode">
      <option value="single">Single Set</option>
      <option value="best_of_3">Best of 3</option>
    </select>
    <label style="width:auto;margin-left:12px;">Point Limit</label>
    <input id="point_limit" type="number" min="1" style="width:100px" />
  </div>

  <div class="teams">
    <div class="team-box">
      <div><strong>Team 1</strong></div>
      <div class="small">Name</div>
      <input id="team1_name" type="text" />
      <div class="small">Score</div>
      <input id="team1_score" type="number" />
      <div class="small">Sets Won</div>
      <input id="team1_sets" type="number" />
    </div>

    <div class="team-box">
      <div><strong>Team 2</strong></div>
      <div class="small">Name</div>
      <input id="team2_name" type="text" />
      <div class="small">Score</div>
      <input id="team2_score" type="number" />
      <div class="small">Sets Won</div>
      <input id="team2_sets" type="number" />
    </div>
  </div>

  <div style="margin-top:12px;display:flex;gap:8px;">
    <button id="saveBtn">Save All</button>
    <button id="courtBtn" class="secondary">코트체인지</button>
    <button id="endSetBtn" class="secondary">세트종료 (End Set)</button>
    <button id="refreshBtn" class="secondary">Refresh</button>
  </div>

  <div style="margin-top:12px;">
    <small>세트종료 버튼은 현재 점수 기준으로 더 높은 팀의 sets_won을 1 증가시키고 current_set을 +1 합니다. (best_of_3 모드에서 동작)</small>
  </div>
</div>

<script>
function getApi(){ return document.getElementById('apiUrl').value.trim(); }
function getToken(){ return document.getElementById('adminToken').value.trim(); }

async function fetchState(){
  const url = getApi();
  if(!url) return alert('API URL을 입력하세요');
  try{
    const res = await fetch(url);
    const j = await res.json();
    populate(j);
  }catch(e){ console.error(e); alert('fetch error'); }
}

function populate(data){
  const cfg = data.config || {};
  const teams = data.teams || [];
  document.getElementById('tournament').value = cfg.tournament || '';
  document.getElementById('mode').value = cfg.mode || 'single';
  document.getElementById('point_limit').value = cfg.point_limit || '';

  if(teams[0]){
    document.getElementById('team1_name').value = teams[0].team_name || '';
    document.getElementById('team1_score').value = teams[0].score ?? 0;
    document.getElementById('team1_sets').value = teams[0].sets_won ?? 0;
  }
  if(teams[1]){
    document.getElementById('team2_name').value = teams[1].team_name || '';
    document.getElementById('team2_score').value = teams[1].score ?? 0;
    document.getElementById('team2_sets').value = teams[1].sets_won ?? 0;
  }
}

async function postAction(payload){
  const url = getApi();
  const token = getToken();
  if(!url || !token) return alert('API URL과 Admin Token을 입력하세요');
  payload.token = token;
  try{
    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const j = await res.json();
    if(!j.ok) console.warn('postAction response', j);
    return j;
  }catch(e){ console.error(e); alert('post error'); }
}

document.getElementById('saveBtn').addEventListener('click', async ()=>{
  await postAction({action:'update_config', key:'tournament', value:document.getElementById('tournament').value});
  await postAction({action:'update_config', key:'mode', value:document.getElementById('mode').value});
  await postAction({action:'update_config', key:'point_limit', value:document.getElementById('point_limit').value});
  await postAction({action:'update_team', team_id:1, team_name:document.getElementById('team1_name').value, score: Number(document.getElementById('team1_score').value), sets_won: Number(document.getElementById('team1_sets').value)});
  await postAction({action:'update_team', team_id:2, team_name:document.getElementById('team2_name').value, score: Number(document.getElementById('team2_score').value), sets_won: Number(document.getElementById('team2_sets').value)});
  alert('Saved');
});

document.getElementById('courtBtn').addEventListener('click', async ()=>{
  await postAction({action:'swap_court'});
  await fetchState();
});

document.getElementById('endSetBtn').addEventListener('click', async ()=>{
  await postAction({action:'end_set'});
  await fetchState();
});

document.getElementById('refreshBtn').addEventListener('click', fetchState);

window.addEventListener('load', ()=>{
  fetchState();
});
</script>
</body>
</html>
