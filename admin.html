<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>스코어보드 관리자</title>
<style>
  body{font-family:"Noto Sans KR",sans-serif;background:#0f172a;color:#e5e7eb;margin:0;}
  .container{max-width:900px;margin:20px auto;padding:0 20px;}
  .card{background:#111827;padding:20px;border-radius:12px;}
  h1{margin:0 0 16px;font-size:22px;font-weight:900;}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0;}
  label{width:120px;font-weight:700;}
  input,select{flex:1;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;}
  .actions{display:flex;gap:10px;margin-top:16px;}
  button{padding:10px 14px;border-radius:8px;border:0;font-weight:800;cursor:pointer;}
  .primary{background:#3b82f6;color:#fff;}
  .danger{background:#ef4444;color:#fff;}
  .ok{background:#10b981;color:#fff;}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>스코어보드 관리자</h1>

    <div class="row"><label>대회명</label><input id="tournament" type="text" /></div>
    <div class="row">
      <label>경기 모드</label>
      <select id="mode">
        <option value="single">단일 세트</option>
        <option value="best_of_3">3세트(2선승)</option>
      </select>
      <label style="width:auto;">점수 제한</label>
      <input id="point_limit" type="number" min="1" />
    </div>

    <div class="row"><label>팀1 이름</label><input id="team1_name" type="text" /></div>
    <div class="row"><label>팀1 점수</label><input id="team1_score" type="number" /></div>
    <div class="row"><label>팀1 세트</label><input id="team1_sets" type="number" /></div>

    <div class="row"><label>팀2 이름</label><input id="team2_name" type="text" /></div>
    <div class="row"><label>팀2 점수</label><input id="team2_score" type="number" /></div>
    <div class="row"><label>팀2 세트</label><input id="team2_sets" type="number" /></div>

    <div class="actions">
      <button class="primary" id="saveBtn">전체 저장</button>
      <button class="ok" id="endSetBtn">세트 종료</button>
      <button class="danger" id="courtBtn">코트 변경</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx0zi0ZIMlvnCro-ggI89C68aVHupn3A-2autiHJTCO20np2ctt3lZnLTf_DSX0bbuz/exec";
const ADMIN_TOKEN = "jceGvOOeuPd0-vRclIuSQS7Pm-n7-BEfcK-sifBsNnRHX4zTzXfLdkWk2_4XF6u8";

async function fetchState(){
  try{
    const res = await fetch(API_URL);
    const j = await res.json();
    populate(j);
  }catch(e){ alert('상태 불러오기 실패'); }
}

function populate(data){
  const cfg = data.config || {};
  const t = data.teams || [];
  document.getElementById('tournament').value = cfg.tournament || '';
  document.getElementById('mode').value = cfg.mode || 'single';
  document.getElementById('point_limit').value = cfg.point_limit || '';
  if(t[0]){
    document.getElementById('team1_name').value = t[0].team_name || '';
    document.getElementById('team1_score').value = t[0].score ?? 0;
    document.getElementById('team1_sets').value = t[0].sets_won ?? 0;
  }
  if(t[1]){
    document.getElementById('team2_name').value = t[1].team_name || '';
    document.getElementById('team2_score').value = t[1].score ?? 0;
    document.getElementById('team2_sets').value = t[1].sets_won ?? 0;
  }
}

async function postAction(payload){
  payload.token = ADMIN_TOKEN;
  try{
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok) alert('요청 실패: '+(j.error||'unknown'));
    return j;
  }catch(e){ alert('저장 실패'); }
}

document.getElementById('saveBtn').addEventListener('click', async ()=>{
  await postAction({action:'update_config', key:'tournament', value:document.getElementById('tournament').value});
  await postAction({action:'update_config', key:'mode', value:document.getElementById('mode').value});
  await postAction({action:'update_config', key:'point_limit', value:document.getElementById('point_limit').value});
  await postAction({action:'update_team', team_id:1, team_name:document.getElementById('team1_name').value, score:Number(document.getElementById('team1_score').value), sets_won:Number(document.getElementById('team1_sets').value)});
  await postAction({action:'update_team', team_id:2, team_name:document.getElementById('team2_name').value, score:Number(document.getElementById('team2_score').value), sets_won:Number(document.getElementById('team2_sets').value)});
  alert('저장되었습니다.');
});

document.getElementById('endSetBtn').addEventListener('click', async ()=>{
  await postAction({action:'end_set'});
  await fetchState();
});

document.getElementById('courtBtn').addEventListener('click', async ()=>{
  await postAction({action:'swap_court'});
  await fetchState();
});

window.addEventListener('load', fetchState);
</script>
</body>
</html>